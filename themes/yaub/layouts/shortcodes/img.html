{{ $_hugo_config := `{ "version": 1 }` }}
{{- $src := .Get "src" }}
{{- $alt := .Get "alt" | default "" }}
{{- $width := .Get "width" | default "" }}
{{- $class := .Get "class" | default "" }}

{{- /* Try to load the image resource */ -}}
{{- $img := "" }}
{{- with .Page.Resources.GetMatch $src }}
  {{- $img = . }}
{{- else }}
  {{- with resources.Get $src }}
    {{- $img = . }}
  {{- end }}
{{- end }}

{{- if $img }}
  {{- /* Image processing available - create WebP version */ -}}
  {{- $webp := $img.Resize (printf "%s webp q85" $width) }}
  {{- $fallback := $img.Resize (printf "%s q85" $width) }}
  
  <picture{{ with $class }} class="{{ . }}"{{ end }}>
    <source srcset="{{ $webp.RelPermalink }}" type="image/webp">
    <source srcset="{{ $fallback.RelPermalink }}" type="image/{{ $img.MediaType.SubType }}">
    <img src="{{ $fallback.RelPermalink }}" alt="{{ $alt }}" loading="lazy"{{ with $width }} width="{{ . }}"{{ end }}>
  </picture>
{{- else }}
  {{- /* Fallback for external or static images */ -}}
  {{- $webpSrc := replace $src ".png" ".webp" | replace ".jpg" ".webp" | replace ".jpeg" ".webp" }}
  <picture{{ with $class }} class="{{ . }}"{{ end }}>
    <source srcset="{{ $webpSrc | relURL }}" type="image/webp">
    <img src="{{ $src | relURL }}" alt="{{ $alt }}" loading="lazy"{{ with $width }} width="{{ . }}"{{ end }}>
  </picture>
{{- end }}

