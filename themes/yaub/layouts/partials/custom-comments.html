<!-- Giscus Comments System
     Requires GitHub Discussions enabled on your repository
     Configure at: https://giscus.app
     
     Add to your config.toml:
     [params.giscus]
       enabled = true
       repo = "your-username/your-repo"
       repoID = "your-repo-id"
       category = "Comments"
       categoryID = "your-category-id"
       mapping = "pathname"
       reactionsEnabled = "1"
       emitMetadata = "0"
       inputPosition = "top"
       theme = "preferred_color_scheme"
       lang = "en"
-->

{{/* Show comments on all single pages except those with disableComments: true */}}
{{ if and .Site.Params.giscus.enabled (not .Params.disableComments) .Section }}
<div class="comments-section" id="comments">
    <hr class="comments-divider" />
    <h3 class="comments-title">
        <i class="fas fa-comments"></i> Discussion
    </h3>
    
    <!-- GDPR-compliant: Comments load only after user consent -->
    <div id="comments-consent" class="comments-consent">
        <div class="consent-box">
            <i class="fab fa-github consent-icon"></i>
            <p class="consent-text">
                Comments are powered by <strong>GitHub Discussions</strong>. 
                To participate, you'll need a GitHub account.
            </p>
            <p class="consent-notice">
                <i class="fas fa-info-circle"></i>
                By loading comments, you agree to GitHub's 
                <a href="https://docs.github.com/en/site-policy/privacy-policies/github-privacy-statement" target="_blank" rel="noopener">Privacy Policy</a>.
                Your data is processed by GitHub, not by this website.
            </p>
            <button id="load-comments-btn" class="load-comments-btn">
                <i class="fas fa-comment-dots"></i> Load Comments
            </button>
            <label class="remember-choice">
                <input type="checkbox" id="remember-consent" />
                <span>Remember my choice for this site</span>
            </label>
        </div>
    </div>
    
    <!-- Giscus container (hidden until consent) -->
    <div id="giscus-container" class="giscus-container" style="display: none;"></div>
</div>

<script>
(function() {
    const consentBox = document.getElementById('comments-consent');
    const giscusContainer = document.getElementById('giscus-container');
    const loadBtn = document.getElementById('load-comments-btn');
    const rememberCheckbox = document.getElementById('remember-consent');
    const storageKey = 'giscus-consent';
    
    // Check if user previously gave consent
    if (localStorage.getItem(storageKey) === 'granted') {
        loadGiscus();
    }
    
    // Handle button click
    if (loadBtn) {
        loadBtn.addEventListener('click', function() {
            if (rememberCheckbox && rememberCheckbox.checked) {
                localStorage.setItem(storageKey, 'granted');
            }
            loadGiscus();
        });
    }
    
    function loadGiscus() {
        if (consentBox) consentBox.style.display = 'none';
        if (giscusContainer) giscusContainer.style.display = 'block';
        
        // Create and inject the Giscus script
        const script = document.createElement('script');
        script.src = 'https://giscus.app/client.js';
        script.setAttribute('data-repo', '{{ .Site.Params.giscus.repo }}');
        script.setAttribute('data-repo-id', '{{ .Site.Params.giscus.repoID }}');
        script.setAttribute('data-category', '{{ .Site.Params.giscus.category | default "Comments" }}');
        script.setAttribute('data-category-id', '{{ .Site.Params.giscus.categoryID }}');
        script.setAttribute('data-mapping', '{{ .Site.Params.giscus.mapping | default "pathname" }}');
        script.setAttribute('data-strict', '0');
        script.setAttribute('data-reactions-enabled', '{{ .Site.Params.giscus.reactionsEnabled | default "1" }}');
        script.setAttribute('data-emit-metadata', '{{ .Site.Params.giscus.emitMetadata | default "0" }}');
        script.setAttribute('data-input-position', '{{ .Site.Params.giscus.inputPosition | default "top" }}');
        script.setAttribute('data-theme', '{{ .Site.Params.giscus.theme | default "preferred_color_scheme" }}');
        script.setAttribute('data-lang', '{{ .Site.Params.giscus.lang | default "en" }}');
        script.setAttribute('data-loading', 'lazy');
        script.crossOrigin = 'anonymous';
        script.async = true;
        
        giscusContainer.appendChild(script);
    }
})();
</script>
{{ end }}
