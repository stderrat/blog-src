<!DOCTYPE html>
<html lang="{{ .Page.Language | default "en" }}" class="no-js">
  <head>
    <script>
      document.documentElement.className = document.documentElement.className.replace('no-js', 'js');
      
      {{- if not .Site.Params.disableThemeToggle }}
      // Apply theme immediately to prevent flash of wrong theme
      (function() {
        var stored = null;
        try { stored = localStorage.getItem('yaub-theme'); } catch(e) {}
        var theme = stored || (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
        document.documentElement.setAttribute('data-theme', theme);
      })();
      {{- end }}
      
      // Detect Mac for keyboard shortcuts (runs before paint to prevent flash)
      if (navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
        document.documentElement.classList.add('is-mac');
      }
      
      var shown = false;
      var isFirstLoad = false;
      
      function showPage() {
        if (shown) return;
        shown = true;
        document.documentElement.classList.remove('fonts-loading');
        // Only animate on first load, not on cached visits
        if (isFirstLoad) {
          document.documentElement.classList.add('fonts-first-load');
        }
        document.documentElement.classList.add('fonts-ready');
        // Mark fonts as cached for future visits
        try { localStorage.setItem('fonts-cached', '1'); } catch(e) {}
      }
      
      // Check if returning visitor with cached fonts
      var fontsCached = false;
      try { fontsCached = localStorage.getItem('fonts-cached') === '1'; } catch(e) {}
      
      if (fontsCached) {
        // Fonts should be cached, show immediately without animation
        document.documentElement.classList.add('fonts-ready');
        shown = true;
      } else {
        // First visit - hide content until ALL fonts load
        isFirstLoad = true;
        document.documentElement.classList.add('fonts-loading');
        
        if (document.fonts && document.fonts.ready) {
          // Wait for ALL fonts to be ready
          document.fonts.ready.then(showPage).catch(showPage);
          // Fallback timeout
          setTimeout(showPage, 1000);
        } else {
          setTimeout(showPage, 800);
        }
      }
    </script>
    {{- with .Site.Params.googleSiteVerification }}
    <meta name="google-site-verification" content="{{ . }}" />
    {{- end }}
    <meta name="color-scheme" content="dark light">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Content Security Policy for XSS protection -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://giscus.app https://pagefind.app;
        style-src 'self' 'unsafe-inline' https://giscus.app;
        img-src 'self' data: https: blob:;
        font-src 'self' data:;
        connect-src 'self' https://giscus.app https://charts.stderr.at;
        frame-src https://giscus.app;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    {{ hugo.Generator }}
    {{ partial "meta.html" . }}
    {{ partial "favicon.html" . }}
    <title>{{ .Title }} {{ default "::" .Site.Params.titleSeparator }} {{ .Site.Title }}</title>
    <link rel="manifest" href="/manifest.json">

    <!-- DNS prefetch and preconnect for third-party resources -->
    <link rel="dns-prefetch" href="https://giscus.app">
    <link rel="preconnect" href="https://giscus.app" crossorigin>
    
    <!-- Preload critical fonts for better LCP - RedHatText is the primary body font -->
    <!-- Note: crossorigin="anonymous" is required for font preloads even for same-origin -->
    <link rel="preload" href="{{ "fonts/RedHatText-Regular.woff" | relURL }}" as="font" type="font/woff" crossorigin="anonymous">
    <link rel="preload" href="{{ "fonts/RedHatText-Medium.woff" | relURL }}" as="font" type="font/woff" crossorigin="anonymous">
    <link rel="preload" href="{{ "webfonts/fa-solid-900.woff2" | relURL }}" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="{{ "webfonts/fa-brands-400.woff2" | relURL }}" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="{{ "webfonts/fa-regular-400.woff2" | relURL }}" as="font" type="font/woff2" crossorigin="anonymous">

    {{ $assetBusting := not .Site.Params.disableAssetsBusting }}
    <meta name="theme-color" content="#317EFB"/>

    <!-- Preload critical CSS for faster First Contentful Paint -->
    {{with .Site.Params.themeVariant}}
    <link rel="preload" href="{{(printf "css/theme-%s-modular.css" .) | relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}" as="style">
    {{end}}
    
    <link href="{{"css/fontawesome-all.min.css" | relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}" rel="stylesheet">
    <link href="{{"css/featherlight.min.css" | relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}" rel="stylesheet">

    {{with .Site.Params.themeVariant}}
    <link href="{{(printf "css/theme-%s-modular.css" .) | relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}" rel="stylesheet">
    {{end}}
    {{ range .Site.Params.custom_css -}}
    <link href="{{(printf "%s" .) | relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}" rel="stylesheet">
    {{- end }}

{{ with .OutputFormats.Get "rss" }}
  {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
{{ end }}


    <script src="{{"js/jquery-3.7.1.min.js"| relURL}}{{ if $assetBusting }}?{{ now.Unix }}{{ end }}"></script>

    <style>
      /* Hide content until fonts are ready to prevent FOUT */
      /* Use opacity instead of visibility to prevent layout recalculation */
      .fonts-loading body { opacity: 0; }
      /* Only animate on first visit - cached fonts show immediately */
      .fonts-ready body { opacity: 1; }
      .fonts-first-load body { 
        opacity: 1;
        animation: contentFadeIn 0.2s ease-out;
      }
      @keyframes contentFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      /* Reserve consistent space for common elements to prevent CLS */
      #top-nav { min-height: 42px; }
      .sub-top-nav { min-height: 45px; }
      h1.gradient-header.article { min-height: 1.2em; }
      
      /* Critical CSS for right sidebar - prevent layout shift */
      #right-sidebar.right-nav-sidebar {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 280px;
        background: var(--MENU-SECTIONS-BG-color, #212427);
        z-index: 90;
        overflow-y: auto;
        padding: 20px 0;
      }
      #right-sidebar.collapsed { width: 0; padding: 0; background: transparent !important; pointer-events: none; }
      body:has(#right-sidebar:not(.collapsed)) #body { margin-right: 280px; }
      @media screen and (max-width: 1400px) {
        #right-sidebar.right-nav-sidebar { width: 250px; }
        body:has(#right-sidebar:not(.collapsed)) #body { margin-right: 250px; }
      }
      @media screen and (max-width: 1200px) {
        #right-sidebar.right-nav-sidebar { width: 220px; }
        body:has(#right-sidebar:not(.collapsed)) #body { margin-right: 220px; }
      }
      @media screen and (max-width: 1024px) {
        #right-sidebar.right-nav-sidebar { display: none; }
        body:has(#right-sidebar) #body { margin-right: 0; }
      }
      
      /* Critical CSS - prevent image flash/layout shift (CLS) - must load first */
      img { max-width: 100% !important; height: auto !important; }
      #body img, #body-inner img, .imageblock img, picture img, article img { 
        max-width: 100% !important; 
        height: auto !important; 
        max-height: 80vh !important;
      }
      /* Only hide images for animation on first visit */
      .fonts-loading #body img, .fonts-loading #body-inner img, .fonts-loading .imageblock img, 
      .fonts-loading picture img, .fonts-loading article img,
      .fonts-first-load #body img, .fonts-first-load #body-inner img, .fonts-first-load .imageblock img,
      .fonts-first-load picture img, .fonts-first-load article img { opacity: 0; }
      .featured-img-container { overflow: hidden; }
      .featured-img { max-width: 100% !important; height: auto !important; box-shadow: none !important; max-height: none !important; }
      .fonts-loading .featured-img, .fonts-first-load .featured-img { opacity: 0; }
      /* Fade-in animation only on first visit */
      @keyframes imgFadeIn { from { opacity: 0; } to { opacity: 1; } }
      .fonts-first-load #body-inner img, .fonts-first-load .imageblock img, 
      .fonts-first-load picture img, .fonts-first-load .featured-img { animation: imgFadeIn 0.3s ease-out 0.05s forwards; }
      /* Skip animation for images replaced by JS or returning visitors */
      img[data-webp-upgraded], img.no-animate { opacity: 1 !important; animation: none !important; }
      /* Returning visitors - show images immediately */
      .fonts-ready:not(.fonts-first-load) img { opacity: 1 !important; }
      
      /* Critical CSS - prevent code block flash (bold to normal, size change) before highlight.js */
      pre code, pre.highlight code, .listingblock pre code {
        font-weight: normal !important;
        font-size: 14px !important;
        line-height: 1.3em !important;
        color: #abb2bf !important;
        background: #282c34 !important;
      }
      pre { background: #282c34 !important; min-height: 36px; }
      
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      {{ if .Site.Params.disableInlineCopyToClipBoard }}
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      {{ end }}
    </style>
    {{ partial "custom-header.html" . }}

    {{ range .AlternativeOutputFormats -}}
      {{ printf `<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
    {{ end -}}

    {{- /* SEO: Breadcrumb structured data for search engines */ -}}
    {{ partial "breadcrumb-jsonld.html" . }}
  </head>
  <body data-url="{{ .RelPermalink }}">
    <!-- Skip to content link for keyboard navigation accessibility -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>
    
    <button onclick="scrollTopAnimated()" id="myBtn" class="top-btn button fa fa-arrow-up" title="Go to top" aria-label="Go to top"></button>

    <span class="read-progress"></span>

    {{ partial "menu.html" . }}
        <main id="body" class="post-content" role="main">
        <div id="overlay"></div>

        {{ if not .Params.chapter }}
          {{ if not (or (eq .Kind "taxonomy") (eq .Kind "term")) }}
          <aside id="toc-field" class="hidden lg:block tableOfContentContainer">
            <header id="TableOfContentsHeader">What's on this Page</header>
            {{ .TableOfContents }}
          </aside>
          {{ end }}
        {{ end }}

        {{ if not .Params.chapter }}
          <div id="navigation">
        {{ end }}
            <!-- Next prev page -->
            {{ $currentNode := . }}

            {{ template "menu-nextprev" dict "menu" .Site.Home "currentnode" $currentNode }}

            {{ define "menu-nextprev" }}
                {{$currentNode := .currentnode }}
                {{ if ne .menu.Params.hidden true}}
                    {{if hasPrefix $currentNode.RelPermalink .menu.RelPermalink }}
                        {{ $currentNode.Scratch.Set "NextPageOK" "OK" }}
                        {{ $currentNode.Scratch.Set "prevPage" ($currentNode.Scratch.Get "prevPageTmp") }}
                    {{else}}
                        {{if eq ($currentNode.Scratch.Get "NextPageOK") "OK"}}
                            {{ $currentNode.Scratch.Set "NextPageOK" nil }}
                            {{ $currentNode.Scratch.Set "nextPage" .menu }}
                        {{end}}
                    {{end}}
                    {{ $currentNode.Scratch.Set "prevPageTmp" .menu }}

                        {{ $currentNode.Scratch.Set "pages" .menu.Pages }}
                        {{ if .menu.IsHome}}
                            {{ $currentNode.Scratch.Set "pages" .menu.Sections }}
                        {{ else if .menu.Sections}}
                            {{ $currentNode.Scratch.Set "pages" (.menu.Pages | union .menu.Sections) }}
                        {{end}}
                        {{ $pages := ($currentNode.Scratch.Get "pages") }}

                        {{ range $pages.ByWeight  }}
                            {{ template "menu-nextprev" dict "menu" . "currentnode" $currentNode }}
                        {{end}}
                {{ end }}
            {{ end }}
      {{$showPrevNext := (and (not .Params.disableNextPrev) (not .Site.Params.disableNextPrev))}}
      {{ if and $showPrevNext (ne .Kind "taxonomy") (ne .Kind "term") }}
        {{ if .Params.chapter }}
          {{/* Section/Chapter pages: Navigate between sibling sections */}}
          {{ $currentSection := . }}
          {{ $sections := site.Home.Sections.ByWeight }}
          {{ $prevSection := false }}
          {{ $nextSection := false }}
          {{ $foundCurrent := false }}
          {{ range $sections }}
            {{ if $foundCurrent }}
              {{ if not $nextSection }}
                {{ $nextSection = . }}
              {{ end }}
            {{ else if eq .RelPermalink $currentSection.RelPermalink }}
              {{ $foundCurrent = true }}
            {{ else }}
              {{ $prevSection = . }}
            {{ end }}
          {{ end }}
          {{ with $prevSection }}
            <a class="nav nav-prev" href="{{.RelPermalink}}" title="{{.Title}}"> <i class="fa fa-chevron-left"></i></a>
          {{ end }}
          {{ with $nextSection }}
            <a class="nav nav-next" href="{{.RelPermalink}}" title="{{.Title}}" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
          {{ end }}
        {{ else }}
          {{/* Regular article pages: Use existing prev/next logic */}}
          {{with ($.Scratch.Get "prevPage")}}
            <a class="nav nav-prev" href="{{.RelPermalink}}" title="{{.Title}}"> <i class="fa fa-chevron-left"></i></a>
          {{end}}
          {{with ($.Scratch.Get "nextPage")}}
            <a class="nav nav-next" href="{{.RelPermalink}}" title="{{.Title}}" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
          {{end}}
        {{ end }}
        </div>
      {{ end }}

        <div id="main-content" class="padding highlightable" tabindex="-1">

          {{ partial "top-navigation.html" . }} 
     
            <div id="head-tags">
            <!-- Do not show on home page -->
            {{ if .Sections}}
            {{else}}
              {{ partial "tags.html" . }}
            {{end}}
            </div>
        {{ if .Params.chapter }}
          <div id="chapter">
        {{ end }}
        <div id="body-inner">
          {{if and (not .IsHome) (not .Params.chapter) }}
            <h1 class="gradient-header article">
              {{ if or (eq .Kind "taxonomy") (eq .Kind "term") }}
                <!-- {{.Data.Singular}} :: -->
              {{ end }}
              {{.Title}}
            </h1>
          {{end}}

        {{define "computeBreadcrumbDepth"}}
          {{$scratch := .origPage.Scratch }}
          {{$parent := .page.Parent }}
          {{ if $parent }}
            {{ $scratch.Set "depth" (add ($scratch.Get "depth") 1) }}
            {{ template "computeBreadcrumbDepth" dict "origPage" .origPage "page" $parent }}
          {{end}}
        {{end}}

        {{define "breadcrumb"}}
          {{$parent := .page.Parent }}
          {{ if $parent }}
            {{/* Check if this parent is the root (has no parent itself) and if root breadcrumb should be hidden */}}
            {{ $parentOfParent := $parent.Parent }}
            {{ $hideRoot := .origPage.Site.Params.disableRootBreadcrumb }}
            {{ if and $hideRoot (not $parentOfParent) }}
              {{/* Skip the root breadcrumb - just output current value */}}
              {{.value|safeHTML}}
            {{ else }}
              {{ $value := (printf "<span itemscope='' itemprop='itemListElement' itemtype='http://schema.org/ListItem'><a itemprop='item' href='%s'> <span itemprop='name'>%s</span><meta itemprop='position' content='%d' /></a></span> > %s" $parent.RelPermalink $parent.Title (sub (.origPage.Scratch.Get "depth") .position) .value ) }}
              {{ template "breadcrumb" dict "origPage" .origPage "page" $parent "value" $value "position" (add .position 1) }}
            {{ end }}
          {{else}}
            {{.value|safeHTML}}
          {{end}}
        {{end}}
