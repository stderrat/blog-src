{{/* Related Articles - Uses Hugo's built-in Related Content feature */}}
{{- $related := .Site.RegularPages.Related . | first 4 -}}

{{ with $related }}
<section class="related-articles" aria-labelledby="related-heading">
    <h3 id="related-heading"><i class="fas fa-link"></i> Related Articles</h3>
    <div class="related-grid">
        {{ range . }}
        {{/* Save the related article context before entering with blocks */}}
        {{ $article := . }}
        {{/* Get position from the RELATED article's frontmatter (not current page) */}}
        {{ $position := .Params.featured_image_position | default "center" }}
        <a href="{{ .RelPermalink }}" class="related-card no-highlight{{ if not .Params.featured_image }} no-image{{ end }}">
            {{/* Only show image container if featured_image exists */}}
            {{ with .Params.featured_image }}
            {{/* 
                featured_image_position controls which part of the image is shown.
                Set in the RELATED article's frontmatter:
                  featured_image_position: "center"      (default)
                  featured_image_position: "top"         (show top of image)
                  featured_image_position: "bottom"      (show bottom)
                  featured_image_position: "center top"  (horizontal center, vertical top)
                  featured_image_position: "20% 80%"     (custom x% y%)
            */}}
            {{ $imgSrc := . }}
            {{ $webpSrc := replace . ".png" ".webp" | replace ".jpg" ".webp" | replace ".jpeg" ".webp" | replace ".PNG" ".webp" | replace ".JPG" ".webp" | replace ".JPEG" ".webp" }}
            {{/* Check if WebP exists */}}
            {{ $webpStaticPath := printf "static%s" $webpSrc }}
            {{ $hasWebp := fileExists $webpStaticPath }}
            <div class="related-card-image">
                {{ if $hasWebp }}
                <picture>
                    <source srcset="{{ $webpSrc }}" type="image/webp">
                    <img src="{{ $imgSrc }}" 
                         alt="Featured image for {{ $article.Title }}" 
                         loading="lazy" 
                         style="object-position: {{ $position }};">
                </picture>
                {{ else }}
                <img src="{{ $imgSrc }}" 
                     alt="Featured image for {{ $article.Title }}" 
                     loading="lazy" 
                     style="object-position: {{ $position }};">
                {{ end }}
            </div>
            {{ end }}
            <div class="related-card-content">
                <span class="related-card-category">
                    {{ with $article.Params.categories }}{{ index . 0 }}{{ end }}
                </span>
                <span class="related-card-title">{{ $article.Title }}</span>
                <span class="related-card-meta">
                    <time datetime="{{ $article.Date.Format "2006-01-02" }}">
                        {{ $article.Date.Format "Jan 2, 2006" }}
                    </time>
                    {{ if $article.Params.authors }}
                    <span class="related-card-author">
                        Â· {{ index $article.Params.authors 0 }}
                    </span>
                    {{ end }}
                </span>
            </div>
        </a>
        {{ end }}
    </div>
</section>
{{ end }}
